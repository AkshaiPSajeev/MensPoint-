<section>
 <div class="container mx-auto">
   <div class="row">
    <div>
      <div class="container  p-5 mt-2">
      {{!-- <form action="" method=""  id="form" ></form> --}}
       <div class="row">
          <div class="col-md-4 mx-5 ">
            <h3 class="text-center">Summary</h3>
            <table class="table table-striped">
              <thead>
               <tr>
                <th scope="col">No.</th>
                <th scope="col">Product</th>
                <th scope="col">Quantity</th>
                <th scope="col">Price </th>
                <th scope="col">Total </th>
               </tr>
              </thead>
              <tbody>
              {{#each orderSummary.Products}}
                <tr>
                 <th scope="row">{{counter @index}}</th>
                 <td><span id="">{{this.Name}}</span></td>
                 <td><span id="">{{this.Quantity}}</span></td>
                 {{#if this.Offer.Status}}
                 <td><span id="">{{this.DiscountedPrice}}</span></td>
                 <td><span id="">{{this.TotalProductPrice}}</span></td>
                 {{else}}
                 <td><span >{{this.Price}}</span></td>
                 <td><span id="">{{this.TotalProductPrice}}</span></td>
                 {{/if}}
                </tr>
              {{/each}}
              </tbody>
            </table>
            <span><strong>Total Amount :</strong></span><strong><span id="total">{{orderSummary.TotalAmount}}</span></strong><br>
            <span id="discountdisplaytag" style="display:none;" class="text-success"><strong> <span id="discountedAmount"></span><span>% discounted Added</span></strong></span>
            <span style="display: none;" id="discountdisplayamount"><strong><span>Total Amount to pay:</span><span id="amounttopay"></span></strong></span>
            {{!-- <form action="" method=""  id="form" disabled></form> --}}
            {{!-- <input type="radio" name="PaymentMode" value="COD"><label for="" class="mx-2" checked>Cash On Delivery</label><br>
            <input type="radio" name="PaymentMode" value="Razorpay"><label for="" class="mx-2">Razorpay</label>
            <input type="radio" name="PaymentMode" value="Paypal"><label for="" class="mx-2">Paypal</label><br>
            <input type="text" name="userId" id="" value="{{userId}}" hidden> --}}
            <p id="error" class="text-danger text-center"></p>
           
            <input type="text" id="coupons" value="{{convertJsonStringify coupons}}" hidden>
            {{#if coupons}}
             <input type="text" id="coupon" placeholder="Enter your coupon code">
            <button class="btn btn-warning" onclick="checkCoupon()">Add coupon</button>
            {{/if}}
            {{!-- {{#if user.Wallet}}
            <span class="text-success font-weight-bold">You have &#8377;{{user.Wallet}} in your Wallet</span><br>
             <input type="number" id="wallet" placeholder="Enter wallet amount " min="1" max="{{user.Wallet}}" class="w-50">
            <button class="btn btn-warning" onclick="checkCoupon()">Add Amount</button>
            {{/if}} --}}
            {{!-- <button type="submit" class="btn btn-primary mt-4  w-100">Place Order</button> --}}
          </div>
          <div class="col-md-4  ">
            <button class="btn btn-success" onclick="enableDelivery()">Add New Address</button> 
            {{!--  <h2 class="text-center ">Delivery Address</h2>--}}
            <p class="text-success" id="message">{{message}}</p>
             <form action="" method=""  id="form" disabled> 
            <input type="hidden"  name="AddressId" id="addressId">
            <label for="">House Name</label>
            <input type="text" name="HouseName" class="form-control" id="housename"  disabled>
            <label for="">Street</label>
            <input type="text" name="Street" class="form-control" id="street"  disabled>
            <label for="">City/District</label>
            <input type="text" name="City" class="form-control" id="city" disabled>
            <label for="">State</label>
            <input type="text" name="State" class="form-control" id="state" disabled>
             <label for="">Pin</label>
            <input type="text" name="Pin" class="form-control" id="pin" disabled><br>
            <input type="radio" name="PaymentMode" value="COD"><label for="" class="mx-2" checked>Cash On Delivery</label><br>
            <input type="radio" name="PaymentMode" value="Razorpay"><label for="" class="mx-2">Razorpay</label><br>
            <input type="radio" name="PaymentMode" value="Paypal"><label for="" class="mx-2">Paypal</label>
            <input type="text" name="userId" id="" value="{{userId}}" hidden>
            <input type="text" name="couponId" id="couponid" hidden>
            <p id="error" class="text-danger text-center"></p>
            <button type="submit" class="btn btn-primary mt-4  w-100">Place Order</button> 
            </form> 
        
          </div>
        
        </div>
      {{!-- </form> --}}
      </div>
   </div>
   
    <div class="d-flex">
      {{#each addresses}}
       <div class="card mt-3 col-md-3 mx-3">
         <div class="card-body ">
          <h5 class="card-title"><input type="radio" name="Delivery address" onclick="addDeliveryAddress('{{this.HouseName}}','{{this.Street}}','{{this.City}}','{{this.State}}','{{this.Pin}}','{{this._id}}')">&nbsp;Select this address</h5>
          <p class="card-text">House Name : <span id="'{{this._id}}'"+"HouseName">{{this.HouseName}}</span> </p>
          <p class="card-text">Street&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: {{this.Street}}</p>
          <p class="card-text">City&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: {{this.City}}</p>
            <p class="card-text">State&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: {{this.State}}</p>
          <p class="card-text">Pin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: {{this.Pin}}</p>
        </div>
      </div>
      {{/each}}
   </div>

  </div>
 </div>
</section>


<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
let housename=document.getElementById('housename');
let street=document.getElementById('street');
let city=document.getElementById('city');
let state=document.getElementById('state');
let pin=document.getElementById('pin');
  function enableDelivery(){
    document.getElementById('housename').disabled=false;
    document.getElementById('street').disabled=false;
    document.getElementById('city').disabled=false;
    document.getElementById('state').disabled=false;
    document.getElementById('pin').disabled=false;
  }
  function addDeliveryAddress(housename,street,city,state,pin,adddressId){
    enableDelivery();
    document.getElementById('housename').value=housename;
    document.getElementById('street').value=street;
    document.getElementById('city').value=city;
    document.getElementById('state').value=state;
    document.getElementById('pin').value=pin;
    document.getElementById('addressId').value=adddressId;
  }

 

form.addEventListener('submit',(e)=>{
 
        if(housename.value==""&&street.value==""&&city.value==""&&state.value==""&&pin.value==""){
            document.getElementById('error').innerHTML="Enter the address fields";
            e.preventDefault();
        }
          else if(housename.value==""){
            document.getElementById('error').innerHTML="Enter house name";
            e.preventDefault();
        }else if(street.value==""){
            document.getElementById('error').innerHTML="Enter street";
            e.preventDefault();
        }else if(city.value==""){
            document.getElementById('error').innerHTML="Enter city or district";
            e.preventDefault();
        }else if(state.value==""){
            document.getElementById('error').innerHTML="Enter the state";
            e.preventDefault();
        }else if(pin.value==""){
            document.getElementById('error').innerHTML="Enter PIN Number";
            e.preventDefault();
        }else{
         
          e.preventDefault()
         $.ajax({
             url:'/place-order',
             method:'post',
            data:$('#form').serialize(),
            success:(response)=>{
             if(response.cod){
                location.href='/orders'
             }else if(response.razorpay){
              
               console.log(response.razobj)
               razorpayPayment(response.razobj)
               
             }else if(response.paypal){
               paypalPayment(response.paypalobj)
             }
             
           }
         })

        }
        {{!-- else  if (!pin.value.match(/^[1-9]{1}[0-9]{2}\\s{0,1}[0-9]{3}$/)) {
            document.getElementById('error').innerHTML="Enter a valid PIN Number";
            e.preventDefault();
        } --}}
    })

    function razorpayPayment(order){
    
      var options = {
    "key": "rzp_test_xyQeGOAtqBltrb", // Enter the Key ID generated from the Dashboard
    "amount":order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Shoppify",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function (response){
        //alert(response.razorpay_payment_id);
        //alert(response.razorpay_order_id);
        //alert(response.razorpay_signature); 
        verifyPayment(response,order);
        
    },
    "prefill": {
        "name": "Shoppify",
        "email": "shoppify@gmail.com",
        "contact": "9999999999"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }

};
var rzp1=new Razorpay(options);
rzp1.open();


    }

    function paypalPayment(data){
    
      for(let i=0;i<data.links.length;i++){
        if(data.links[i].rel==='approval_url'){
          window.location.href=(data.links[i].href);
          
        }
      }
    }

     function verifyPayment(payment,order){
    
      $.ajax({
        url:'/verify-payment',
        data:{
          payment,
          order
        },
        method:'post',
        success:(response)=>{
          if(response.status){
           
             location.href='/orders'
          }else{
            alert('payment failed')
          }
        }
      })
    }
</script>
